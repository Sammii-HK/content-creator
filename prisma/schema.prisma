// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed password
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  videos    Video[]
  broll     Broll[]
  personas  VoiceProfile[]
  templates Template[]
  
  @@map("users")
}

model Video {
  id         String    @id @default(cuid())
  theme      String
  tone       String
  duration   Int       // Duration in seconds
  hookLines  String[]  // Array of hook lines
  caption    String
  templateId     String?
  brollId        String?
  brollSegmentId String? // Specific segment used for this video
  fileUrl        String  // URL to the rendered video file
  features   Json?     // Visual/textual features for ML
  createdAt  DateTime  @default(now())
  personaId  String?
  userId     String    // Owner of this video
  
  // Relations
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  template      Template?        @relation(fields: [templateId], references: [id])
  broll         Broll?           @relation(fields: [brollId], references: [id])
  brollSegment  BrollSegment?    @relation(fields: [brollSegmentId], references: [id])
  persona       VoiceProfile?    @relation(fields: [personaId], references: [id])
  metrics       Metrics?
  abTestVariant AbTestVariant[]
  contentQueue  ContentQueue[]
  
  @@map("videos")
}

model Metrics {
  id              String  @id @default(cuid())
  videoId         String  @unique
  views           Int?
  likes           Int?
  shares          Int?
  comments        Int?
  completionRate  Float?  // Percentage of video watched
  engagement      Float?  // Calculated engagement score
  visualScore     Float?  // ML-generated visual appeal score
  toneScore       Float?  // ML-generated tone effectiveness score
  predictedScore  Float?  // Predicted engagement before posting
  actualScore     Float?  // Actual performance score
  
  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)
  
  @@map("metrics")
}

model Template {
  id          String    @id @default(cuid())
  name        String
  json        Json      // Template configuration (timing, positions, filters)
  parentId    String?   // For template evolution tracking
  performance Float?    // Average performance score
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  personaId   String?
  userId      String?   // Owner of this template
  
  // Relations
  user     User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   Template?  @relation("TemplateEvolution", fields: [parentId], references: [id])
  children Template[] @relation("TemplateEvolution")
  videos   Video[]
  persona  VoiceProfile? @relation(fields: [personaId], references: [id])
  
  @@map("templates")
}

model Trend {
  id          String   @id @default(cuid())
  tag         String
  platform    String   // "tiktok", "instagram", "youtube"
  popularity  Int      // Trend popularity score
  mood        String?  // Detected mood/sentiment
  category    String?  // Content category
  collectedAt DateTime @default(now())
  
  @@unique([tag, platform])
  @@map("trends")
}

model Broll {
  id          String   @id @default(cuid())
  name        String
  description String?
  fileUrl     String   // URL to the source video file
  duration    Int      // Total duration in seconds
  category    String?  // Category for organization
  tags        String[] // Tags for searchability
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  personaId   String?
  userId      String   // Owner of this broll
  
  // Relations
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  videos   Video[]
  segments BrollSegment[]
  persona  VoiceProfile? @relation(fields: [personaId], references: [id])
  
  @@map("broll")
}

model BrollSegment {
  id          String  @id @default(cuid())
  brollId     String
  name        String  // Name for this segment
  startTime   Float   // Start timestamp in seconds (e.g., 5.5)
  endTime     Float   // End timestamp in seconds (e.g., 12.3)
  quality     Int     @default(5) // Quality rating 1-10
  mood        String? // Mood/vibe of this segment
  description String? // What happens in this segment
  tags        String[] // Specific tags for this segment
  isUsable    Boolean @default(true) // Whether this segment is good to use
  usageCount  Int     @default(0) // How many times it's been used
  
  // Relations
  broll Broll   @relation(fields: [brollId], references: [id], onDelete: Cascade)
  videos Video[]
  
  @@map("broll_segments")
}

model AbTest {
  id          String   @id @default(cuid())
  name        String
  description String?
  status      String   @default("active") // "active", "completed", "paused"
  startDate   DateTime @default(now())
  endDate     DateTime?
  
  // Test configuration
  variants    AbTestVariant[]
  
  @@map("ab_tests")
}

model AbTestVariant {
  id        String @id @default(cuid())
  testId    String
  name      String
  videoId   String
  isControl Boolean @default(false)
  
  // Performance metrics
  views         Int?
  engagement    Float?
  conversionRate Float?
  
  // Relations
  test  AbTest @relation(fields: [testId], references: [id], onDelete: Cascade)
  video Video  @relation(fields: [videoId], references: [id])
  
  @@map("ab_test_variants")
}

model ContentQueue {
  id          String   @id @default(cuid())
  videoId     String
  scheduledAt DateTime
  status      String   @default("pending") // "pending", "posted", "failed"
  platform    String   // "tiktok", "instagram", "youtube"
  postId      String?  // External platform post ID
  createdAt   DateTime @default(now())
  personaId   String?
  
  // Relations
  video   Video @relation(fields: [videoId], references: [id])
  persona VoiceProfile? @relation(fields: [personaId], references: [id])
  
  @@map("content_queue")
}

model MLModel {
  id          String   @id @default(cuid())
  name        String
  version     String
  modelPath   String   // Path to the trained model file
  performance Json     // Model performance metrics
  isActive    Boolean  @default(false)
  trainedAt   DateTime @default(now())
  
  @@unique([name, version])
  @@map("ml_models")
}

// Digital Me Voice Learning Models - Multi-Persona System
model VoiceExample {
  id          String   @id @default(cuid())
  personaId   String   // Link to specific persona
  theme       String
  tone        String
  hook        String
  body        String
  caption     String?
  tags        String[]
  engagement  Float?
  embedding   Float[]  // Vector embedding for similarity search
  createdAt   DateTime @default(now())
  
  // Relations
  persona VoiceProfile @relation(fields: [personaId], references: [id], onDelete: Cascade)
  
  @@map("voice_examples")
}

model VoiceProfile {
  id             String   @id @default(cuid())
  name           String   // Persona name (e.g., "Succulent Expert", "Tech Reviewer", "Fitness Coach")
  description    String?  // What this persona is about
  niche          String   // Content niche (e.g., "plants", "tech", "fitness", "business")
  summary        String   // AI-generated summary of voice characteristics
  preferredTones String[] // Top-performing tones for this persona
  topThemes      String[] // Most common themes
  lexicalTraits  Json     // Writing style characteristics
  blueprint      Json?    // Full persona blueprint JSON
  guidancePrompts Json?   // Saved prompt packs or guidance
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         String   // Owner of this persona
  
  // Relations
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  examples VoiceExample[]
  templates Template[]
  videos    Video[]
  broll     Broll[]
  contentQueue ContentQueue[]
  assets    Asset[]
  generatedImages GeneratedImage[]
  aiUsage   AiUsage[]
  
  @@map("voice_profiles")
}

// Asset Bank Models
model Asset {
  id          String   @id @default(cuid())
  name        String
  type        String   // 'model', 'product', 'environment'
  imageUrl    String
  tags        String[]
  category    String
  subcategory String?
  style       String
  mood        String?
  useCases    String[]
  isFavorite  Boolean  @default(false)
  metadata    Json     // File size, dimensions, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  personaId   String?
  
  // Relations
  persona VoiceProfile? @relation(fields: [personaId], references: [id])
  
  @@map("assets")
}

model GeneratedImage {
  id          String   @id @default(cuid())
  imageUrl    String
  prompt      String
  style       String
  quality     String
  provider    String
  cost        Float
  assetIds    String[] // Which assets were used
  metadata    Json     // Generation details
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  personaId   String?
  
  // Relations
  persona VoiceProfile? @relation(fields: [personaId], references: [id])
  
  @@map("generated_images")
}

// AI Usage Tracking
model AiUsage {
  id           String   @id @default(cuid())
  provider     String   // replicate, nano-banana, stability-ai, dalle-3, etc.
  requestType  String   // product-photo, scene-generation, avatar-video, etc.
  cost         Float    // Cost in USD
  success      Boolean  // Whether the request succeeded
  prompt       String   // Truncated prompt for analysis
  quality      String   // budget, standard, premium
  responseTime Int      // Response time in milliseconds
  errorMessage String?  // Error message if failed
  metadata     Json     // Additional request/response data
  createdAt    DateTime @default(now())
  personaId    String?
  
  // Relations
  persona VoiceProfile? @relation(fields: [personaId], references: [id])
  
  @@map("ai_usage")
}